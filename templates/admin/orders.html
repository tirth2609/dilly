{% extends "layout.html" %}

{% block title %}Manage Orders - Admin Dashboard{% endblock %}

{% block extra_css %}
<style>
    .sidebar {
        height: calc(100vh - 75px);
        position: sticky;
        top: 75px;
    }
    
    .dashboard-content {
        min-height: calc(100vh - 75px);
    }
    
    .nav-pills .nav-link.active {
        background-color: var(--accent-color);
    }

    .table-action-btn {
        width: 32px;
        height: 32px;
        padding: 0;
        line-height: 32px;
        text-align: center;
    }
    
    .order-badge {
        display: inline-block;
        padding: 0.25rem 0.5rem;
        font-size: 0.75rem;
        font-weight: 600;
        border-radius: 0.25rem;
    }
    
    .order-item {
        padding: 10px;
        border-bottom: 1px solid #f0f0f0;
    }
    
    .order-item:last-child {
        border-bottom: none;
    }
    
    .order-status-timeline {
        display: flex;
        justify-content: space-between;
        margin-bottom: 2rem;
        position: relative;
    }
    
    .order-status-timeline::before {
        content: '';
        position: absolute;
        top: 1.5rem;
        left: 0;
        width: 100%;
        height: 2px;
        background-color: #e9ecef;
        z-index: 0;
    }
    
    .status-step {
        position: relative;
        z-index: 1;
        text-align: center;
    }
    
    .status-marker {
        width: 3rem;
        height: 3rem;
        border-radius: 50%;
        background-color: #e9ecef;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 0.5rem;
        color: #fff;
    }
    
    .status-marker.active {
        background-color: var(--accent-color);
    }
    
    .status-marker.completed {
        background-color: var(--secondary-color);
    }
    
    .status-text {
        font-size: 0.75rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row">
        <div class="col-lg-3 col-xl-2">
            <div class="sidebar bg-light p-3 rounded">
                <h5 class="mb-3">Admin Menu</h5>
                <div class="nav flex-column nav-pills">
                    <a class="nav-link" href="{{ url_for('admin_dashboard') }}">
                        <i class="fas fa-tachometer-alt me-2"></i> Dashboard
                    </a>
                    <a class="nav-link" href="{{ url_for('admin_menu_items') }}">
                        <i class="fas fa-utensils me-2"></i> Manage Menu
                    </a>
                    <a class="nav-link" href="{{ url_for('admin_categories') }}">
                        <i class="fas fa-tags me-2"></i> Categories
                    </a>
                    <a class="nav-link" href="{{ url_for('admin_reservations') }}">
                        <i class="fas fa-calendar-check me-2"></i> Reservations
                    </a>
                    <a class="nav-link" href="{{ url_for('admin_banquets') }}">
                        <i class="fas fa-glass-cheers me-2"></i> Banquet Bookings
                    </a>
                    <a class="nav-link active" href="{{ url_for('admin_orders') }}">
                        <i class="fas fa-shopping-cart me-2"></i> Orders
                    </a>
                    <a class="nav-link" href="{{ url_for('admin_users') }}">
                        <i class="fas fa-users me-2"></i> Users
                    </a>
                    <a class="nav-link" href="{{ url_for('admin_tables') }}">
                        <i class="fas fa-chair me-2"></i> Tables
                    </a>
                    <a class="nav-link" href="{{ url_for('admin_settings') }}">
                        <i class="fas fa-cog me-2"></i> Settings
                    </a>
                </div>
            </div>
        </div>
        <div class="col-lg-9 col-xl-10">
            <div class="dashboard-content">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h3 class="mb-0">Manage Orders</h3>
                    <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#addOrderModal">
                        <i class="fas fa-plus me-2"></i> Create Order
                    </button>
                </div>
                
                <!-- Filter Controls -->
                <div class="card border-0 shadow mb-4">
                    <div class="card-body">
                        <div class="row align-items-end">
                            <div class="col-md-3 mb-3 mb-md-0">
                                <label for="dateFilter" class="form-label">Date Range</label>
                                <select id="dateFilter" class="form-select">
                                    <option value="all">All Time</option>
                                    <option value="today">Today</option>
                                    <option value="yesterday">Yesterday</option>
                                    <option value="week">This Week</option>
                                    <option value="month">This Month</option>
                                </select>
                            </div>
                            <div class="col-md-3 mb-3 mb-md-0">
                                <label for="statusFilter" class="form-label">Order Status</label>
                                <select id="statusFilter" class="form-select">
                                    <option value="all">All Statuses</option>
                                    <option value="pending">Pending</option>
                                    <option value="preparing">Preparing</option>
                                    <option value="ready">Ready</option>
                                    <option value="completed">Completed</option>
                                    <option value="cancelled">Cancelled</option>
                                </select>
                            </div>
                            <div class="col-md-3 mb-3 mb-md-0">
                                <label for="typeFilter" class="form-label">Order Type</label>
                                <select id="typeFilter" class="form-select">
                                    <option value="all">All Types</option>
                                    <option value="dine-in">Dine-in</option>
                                    <option value="takeaway">Takeaway</option>
                                    <option value="delivery">Delivery</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label for="searchOrder" class="form-label">Search</label>
                                <input type="text" id="searchOrder" class="form-control" placeholder="Order ID, Name...">
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Statistics Cards -->
                <div class="row mb-4">
                    <div class="col-md-3 mb-3 mb-md-0">
                        <div class="card border-0 shadow h-100">
                            <div class="card-body">
                                <h6 class="text-muted">Total Orders</h6>
                                <div class="d-flex align-items-center">
                                    <div class="flex-shrink-0 bg-primary p-3 rounded">
                                        <i class="fas fa-shopping-cart text-white"></i>
                                    </div>
                                    <div class="ms-3">
                                        <h3 class="mb-0">{{ orders|length }}</h3>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3 mb-md-0">
                        <div class="card border-0 shadow h-100">
                            <div class="card-body">
                                <h6 class="text-muted">Pending Orders</h6>
                                <div class="d-flex align-items-center">
                                    <div class="flex-shrink-0 bg-warning p-3 rounded">
                                        <i class="fas fa-clock text-white"></i>
                                    </div>
                                    <div class="ms-3">
                                        <h3 class="mb-0">{{ orders|selectattr('status', 'equalto', 'pending')|list|length }}</h3>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3 mb-md-0">
                        <div class="card border-0 shadow h-100">
                            <div class="card-body">
                                <h6 class="text-muted">Today's Revenue</h6>
                                <div class="d-flex align-items-center">
                                    <div class="flex-shrink-0 bg-success p-3 rounded">
                                        <i class="fas fa-rupee-sign text-white"></i>
                                    </div>
                                    <div class="ms-3">
                                        <h3 class="mb-0">â‚¹{{ todays_revenue }}</h3>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card border-0 shadow h-100">
                            <div class="card-body">
                                <h6 class="text-muted">Avg. Order Value</h6>
                                <div class="d-flex align-items-center">
                                    <div class="flex-shrink-0 bg-info p-3 rounded">
                                        <i class="fas fa-chart-line text-white"></i>
                                    </div>
                                    <div class="ms-3">
                                        <h3 class="mb-0">â‚¹{{ avg_order_value }}</h3>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Orders Table -->
                <div class="card border-0 shadow">
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>Order ID</th>
                                        <th>Customer</th>
                                        <th>Type</th>
                                        <th>Date</th>
                                        <th>Items</th>
                                        <th>Total</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for order in orders %}
                                    <tr data-status="{{ order.status }}" data-type="{{ order.order_type }}">
                                        <td>#{{ order.id }}</td>
                                        <td>
                                            <div>{{ order.name }}</div>
                                            <small class="text-muted">{{ order.phone }}</small>
                                        </td>
                                        <td>
                                            {% if order.order_type == 'dine-in' %}
                                                <span class="badge bg-info">Dine-in</span>
                                                {% if order.table_number %}
                                                <div class="small">Table #{{ order.table_number }}</div>
                                                {% endif %}
                                            {% elif order.order_type == 'takeaway' %}
                                                <span class="badge bg-primary">Takeaway</span>
                                            {% elif order.order_type == 'delivery' %}
                                                <span class="badge bg-secondary">Delivery</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            <div>{{ order.created_at.strftime('%d %b %Y') }}</div>
                                            <small class="text-muted">{{ order.created_at.strftime('%I:%M %p') }}</small>
                                        </td>
                                        <td>{{ order.items|length }} items</td>
                                        <td>â‚¹{{ "%.2f"|format(order.total_amount) }}</td>
                                        <td>
                                            {% if order.status == 'pending' %}
                                                <span class="badge bg-warning">{{ order.status }}</span>
                                            {% elif order.status == 'preparing' %}
                                                <span class="badge bg-primary">{{ order.status }}</span>
                                            {% elif order.status == 'ready' %}
                                                <span class="badge bg-info">{{ order.status }}</span>
                                            {% elif order.status == 'completed' %}
                                                <span class="badge bg-success">{{ order.status }}</span>
                                            {% elif order.status == 'cancelled' %}
                                                <span class="badge bg-danger">{{ order.status }}</span>
                                            {% endif %}
                                            <div class="small mt-1">
                                                <span class="badge {% if order.payment_status == 'completed' %}bg-success{% else %}bg-warning{% endif %}">
                                                    {{ order.payment_status }}
                                                </span>
                                            </div>
                                        </td>
                                        <td>
                                            <div class="btn-group">
                                                <button type="button" class="btn btn-sm btn-primary table-action-btn view-order-btn" 
                                                        data-id="{{ order.id }}"
                                                        data-bs-toggle="modal" 
                                                        data-bs-target="#viewOrderModal">
                                                    <i class="fas fa-eye"></i>
                                                </button>
                                                <button type="button" class="btn btn-sm btn-info table-action-btn update-status-btn" 
                                                        data-id="{{ order.id }}"
                                                        data-status="{{ order.status }}"
                                                        data-bs-toggle="modal" 
                                                        data-bs-target="#updateStatusModal">
                                                    <i class="fas fa-sync-alt"></i>
                                                </button>
                                                {% if order.status == 'pending' %}
                                                <button type="button" class="btn btn-sm btn-danger table-action-btn cancel-order-btn"
                                                        data-id="{{ order.id }}"
                                                        data-bs-toggle="modal" 
                                                        data-bs-target="#cancelOrderModal">
                                                    <i class="fas fa-times"></i>
                                                </button>
                                                {% endif %}
                                            </div>
                                        </td>
                                    </tr>
                                    {% else %}
                                    <tr>
                                        <td colspan="8" class="text-center py-3">No orders found.</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <!-- Order Statistics -->
                <div class="row mt-4">
                    <div class="col-md-6">
                        <div class="card border-0 shadow">
                            <div class="card-body">
                                <h5 class="card-title">Orders by Type</h5>
                                <canvas id="orderTypeChart" height="250"></canvas>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card border-0 shadow">
                            <div class="card-body">
                                <h5 class="card-title">Orders by Time of Day</h5>
                                <canvas id="orderTimeChart" height="250"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- View Order Modal -->
<div class="modal fade" id="viewOrderModal" tabindex="-1" aria-labelledby="viewOrderModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="viewOrderModalLabel">Order Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="order-details-loading" class="text-center py-4">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2">Loading order details...</p>
                </div>
                <div id="order-details" style="display: none;">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <div>
                            <h5 class="mb-0">Order <span id="view_order_id"></span></h5>
                            <p class="text-muted mb-0" id="view_order_date"></p>
                        </div>
                        <div>
                            <span class="badge bg-success" id="view_order_status"></span>
                        </div>
                    </div>
                    
                    <!-- Order Status Timeline -->
                    <div class="order-status-timeline mb-4">
                        <div class="status-step">
                            <div class="status-marker" id="status-pending">
                                <i class="fas fa-hourglass-start"></i>
                            </div>
                            <div class="status-text">Pending</div>
                        </div>
                        <div class="status-step">
                            <div class="status-marker" id="status-preparing">
                                <i class="fas fa-utensils"></i>
                            </div>
                            <div class="status-text">Preparing</div>
                        </div>
                        <div class="status-step">
                            <div class="status-marker" id="status-ready">
                                <i class="fas fa-check"></i>
                            </div>
                            <div class="status-text">Ready</div>
                        </div>
                        <div class="status-step">
                            <div class="status-marker" id="status-completed">
                                <i class="fas fa-flag-checkered"></i>
                            </div>
                            <div class="status-text">Completed</div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card mb-3">
                                <div class="card-header">
                                    <h6 class="mb-0">Customer Information</h6>
                                </div>
                                <div class="card-body">
                                    <p><strong>Name:</strong> <span id="view_customer_name"></span></p>
                                    <p><strong>Email:</strong> <span id="view_customer_email"></span></p>
                                    <p><strong>Phone:</strong> <span id="view_customer_phone"></span></p>
                                    <p><strong>Order Type:</strong> <span id="view_order_type"></span></p>
                                    <div id="view_table_info">
                                        <p><strong>Table Number:</strong> <span id="view_table_number"></span></p>
                                    </div>
                                    <div id="view_address_info" style="display: none;">
                                        <p><strong>Delivery Address:</strong></p>
                                        <p id="view_delivery_address"></p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card mb-3">
                                <div class="card-header">
                                    <h6 class="mb-0">Payment Information</h6>
                                </div>
                                <div class="card-body">
                                    <p><strong>Payment Method:</strong> <span id="view_payment_method"></span></p>
                                    <p><strong>Payment Status:</strong> <span id="view_payment_status"></span></p>
                                    <p><strong>Total Amount:</strong> <span id="view_total_amount"></span></p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card mb-3">
                        <div class="card-header">
                            <h6 class="mb-0">Order Items</h6>
                        </div>
                        <div class="card-body p-0">
                            <div id="view_order_items"></div>
                            <div class="p-3 border-top">
                                <div class="d-flex justify-content-between">
                                    <strong>Total:</strong>
                                    <strong id="view_items_total"></strong>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div id="view_special_instructions_card" class="card mb-3">
                        <div class="card-header">
                            <h6 class="mb-0">Special Instructions</h6>
                        </div>
                        <div class="card-body">
                            <p id="view_special_instructions" class="mb-0"></p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary update-status-from-view" data-bs-dismiss="modal" data-id="">Update Status</button>
                <button type="button" class="btn btn-success mark-as-paid" data-id="">Mark as Paid</button>
            </div>
        </div>
    </div>
</div>

<!-- Update Status Modal -->
<div class="modal fade" id="updateStatusModal" tabindex="-1" aria-labelledby="updateStatusModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form action="{{ url_for('admin_update_order_status') }}" method="POST">
                <div class="modal-header">
                    <h5 class="modal-title" id="updateStatusModalLabel">Update Order Status</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="update_order_id" name="order_id">
                    <div class="mb-3">
                        <label for="update_status" class="form-label">Select New Status</label>
                        <select class="form-select" id="update_status" name="status" required>
                            <option value="pending">Pending</option>
                            <option value="preparing">Preparing</option>
                            <option value="ready">Ready</option>
                            <option value="completed">Completed</option>
                            <option value="cancelled">Cancelled</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="update_payment_status" class="form-label">Payment Status</label>
                        <select class="form-select" id="update_payment_status" name="payment_status">
                            <option value="pending">Pending</option>
                            <option value="completed">Completed</option>
                        </select>
                    </div>
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="send_notification" name="send_notification" checked>
                        <label class="form-check-label" for="send_notification">
                            Send notification to customer
                        </label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Update Status</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Cancel Order Modal -->
<div class="modal fade" id="cancelOrderModal" tabindex="-1" aria-labelledby="cancelOrderModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form action="{{ url_for('admin_cancel_order') }}" method="POST">
                <div class="modal-header">
                    <h5 class="modal-title" id="cancelOrderModalLabel">Cancel Order</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="cancel_order_id" name="order_id">
                    <p>Are you sure you want to cancel this order?</p>
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        Cancelling an order cannot be undone. The customer will be notified.
                    </div>
                    <div class="mb-3">
                        <label for="cancel_reason" class="form-label">Reason for Cancellation</label>
                        <textarea class="form-control" id="cancel_reason" name="reason" rows="3" required></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="submit" class="btn btn-danger">Cancel Order</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Add Order Modal -->
<div class="modal fade" id="addOrderModal" tabindex="-1" aria-labelledby="addOrderModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <form action="{{ url_for('admin_add_order') }}" method="POST">
                <div class="modal-header">
                    <h5 class="modal-title" id="addOrderModalLabel">Create New Order</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-4">
                            <div class="card border-0 shadow h-100">
                                <div class="card-header bg-light">
                                    <h5 class="card-title mb-0">Customer Information</h5>
                                </div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        <label for="customer_name" class="form-label">Full Name</label>
                                        <input type="text" class="form-control" id="customer_name" name="name" required>
                                    </div>
                                    <div class="mb-3">
                                        <label for="customer_email" class="form-label">Email</label>
                                        <input type="email" class="form-control" id="customer_email" name="email" required>
                                    </div>
                                    <div class="mb-3">
                                        <label for="customer_phone" class="form-label">Phone</label>
                                        <input type="text" class="form-control" id="customer_phone" name="phone" required>
                                    </div>
                                    <div class="mb-3">
                                        <label for="order_type" class="form-label">Order Type</label>
                                        <select class="form-select" id="order_type" name="order_type" required>
                                            <option value="dine-in">Dine-in</option>
                                            <option value="takeaway">Takeaway</option>
                                            <option value="delivery">Delivery</option>
                                        </select>
                                    </div>
                                    <div class="mb-3" id="table_number_div">
                                        <label for="table_number" class="form-label">Table Number</label>
                                        <input type="number" class="form-control" id="table_number" name="table_number" min="1">
                                    </div>
                                    <div class="mb-3" id="address_div" style="display: none;">
                                        <label for="address" class="form-label">Delivery Address</label>
                                        <textarea class="form-control" id="address" name="address" rows="3"></textarea>
                                    </div>
                                    <div class="mb-3">
                                        <label for="special_instructions" class="form-label">Special Instructions</label>
                                        <textarea class="form-control" id="special_instructions" name="special_instructions" rows="2"></textarea>
                                    </div>
                                    <div class="mb-3">
                                        <label for="payment_method" class="form-label">Payment Method</label>
                                        <select class="form-select" id="payment_method" name="payment_method" required>
                                            <option value="counter">Pay at Counter</option>
                                            <option value="cash-on-delivery">Cash on Delivery</option>
                                            <option value="pickup">Pay on Pickup</option>
                                            <option value="upi">UPI Payment</option>
                                        </select>
                                    </div>
                                    <div class="mb-3">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="payment_completed" name="payment_completed">
                                            <label class="form-check-label" for="payment_completed">
                                                Payment Completed
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-8">
                            <div class="card border-0 shadow h-100">
                                <div class="card-header bg-light">
                                    <h5 class="card-title mb-0">Order Items</h5>
                                </div>
                                <div class="card-body">
                                    <div class="row mb-3">
                                        <div class="col-md-6">
                                            <select class="form-select" id="menu_item_select">
                                                <option value="">Select Menu Item</option>
                                                {% for category in categories %}
                                                <optgroup label="{{ category.name }}">
                                                    {% for item in category.menu_items %}
                                                    <option value="{{ item.id }}" data-name="{{ item.name }}" data-price="{{ item.price }}">
                                                        {{ item.name }} - â‚¹{{ "%.2f"|format(item.price) }}
                                                    </option>
                                                    {% endfor %}
                                                </optgroup>
                                                {% endfor %}
                                            </select>
                                        </div>
                                        <div class="col-md-3">
                                            <input type="number" class="form-control" id="item_quantity" placeholder="Quantity" min="1" value="1">
                                        </div>
                                        <div class="col-md-3">
                                            <button type="button" class="btn btn-primary w-100" id="add_item_btn">
                                                <i class="fas fa-plus me-2"></i> Add
                                            </button>
                                        </div>
                                    </div>
                                    
                                    <div class="table-responsive">
                                        <table class="table" id="order_items_table">
                                            <thead>
                                                <tr>
                                                    <th>Item</th>
                                                    <th>Price</th>
                                                    <th>Quantity</th>
                                                    <th>Total</th>
                                                    <th>Actions</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <tr id="no_items_row">
                                                    <td colspan="5" class="text-center">No items added to the order yet.</td>
                                                </tr>
                                            </tbody>
                                            <tfoot>
                                                <tr>
                                                    <th colspan="3" class="text-end">Total:</th>
                                                    <th id="order_total">â‚¹0.00</th>
                                                    <th></th>
                                                </tr>
                                            </tfoot>
                                        </table>
                                    </div>
                                    
                                    <!-- Hidden input to store the order items -->
                                    <input type="hidden" id="order_items_json" name="order_items_json" value="[]">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-success">Create Order</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.0/dist/chart.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Update Status
        const updateStatusBtns = document.querySelectorAll('.update-status-btn');
        updateStatusBtns.forEach(btn => {
            btn.addEventListener('click', function() {
                const orderId = this.getAttribute('data-id');
                const currentStatus = this.getAttribute('data-status');
                
                document.getElementById('update_order_id').value = orderId;
                document.getElementById('update_status').value = currentStatus;
            });
        });
        
        // Cancel Order
        const cancelOrderBtns = document.querySelectorAll('.cancel-order-btn');
        cancelOrderBtns.forEach(btn => {
            btn.addEventListener('click', function() {
                const orderId = this.getAttribute('data-id');
                document.getElementById('cancel_order_id').value = orderId;
            });
        });
        
        // View Order Details
        const viewOrderBtns = document.querySelectorAll('.view-order-btn');
        viewOrderBtns.forEach(btn => {
            btn.addEventListener('click', function() {
                const orderId = this.getAttribute('data-id');
                document.querySelector('.update-status-from-view').setAttribute('data-id', orderId);
                document.querySelector('.mark-as-paid').setAttribute('data-id', orderId);
                
                // Show loading and hide details
                document.getElementById('order-details-loading').style.display = 'block';
                document.getElementById('order-details').style.display = 'none';
                
                // In a real app, this would make an AJAX call to get order details
                // Get the order details
                    // Get data from the table row (in a real app, this data would come from an API call)
                    const row = this.closest('tr');
                    const orderIdText = row.querySelector('td:nth-child(1)').textContent;
                    const customerName = row.querySelector('td:nth-child(2)').textContent.split('\n')[0].trim();
                    const customerPhone = row.querySelector('td:nth-child(2)').textContent.split('\n')[1].trim();
                    const orderType = row.querySelector('td:nth-child(3) .badge').textContent;
                    let tableNumber = '';
                    const tableNumberEl = row.querySelector('td:nth-child(3) .small');
                    if (tableNumberEl) {
                        tableNumber = tableNumberEl.textContent.replace('Table #', '');
                    }
                    const orderDate = row.querySelector('td:nth-child(4)').textContent.split('\n')[0].trim();
                    const orderTime = row.querySelector('td:nth-child(4)').textContent.split('\n')[1].trim();
                    const itemsCount = row.querySelector('td:nth-child(5)').textContent;
                    const totalAmount = row.querySelector('td:nth-child(6)').textContent;
                    const status = row.querySelector('td:nth-child(7) .badge').textContent;
                    const paymentStatus = row.querySelector('td:nth-child(7) .small .badge').textContent;
                    
                    // Populate modal with data
                    document.getElementById('view_order_id').textContent = orderIdText;
                    document.getElementById('view_order_date').textContent = `${orderDate} at ${orderTime}`;
                    document.getElementById('view_customer_name').textContent = customerName;
                    document.getElementById('view_customer_email').textContent = 'customer@example.com'; // In a real app, this would come from the API
                    document.getElementById('view_customer_phone').textContent = customerPhone;
                    document.getElementById('view_order_type').textContent = orderType;
                    
                    // Show/hide table or address info based on order type
                    if (orderType.toLowerCase() === 'dine-in') {
                        document.getElementById('view_table_info').style.display = 'block';
                        document.getElementById('view_table_number').textContent = tableNumber;
                        document.getElementById('view_address_info').style.display = 'none';
                    } else if (orderType.toLowerCase() === 'delivery') {
                        document.getElementById('view_table_info').style.display = 'none';
                        document.getElementById('view_address_info').style.display = 'block';
                        document.getElementById('view_delivery_address').textContent = '123 Main St, Apt 4B, Bangalore 560001'; // Example address
                    } else {
                        document.getElementById('view_table_info').style.display = 'none';
                        document.getElementById('view_address_info').style.display = 'none';
                    }
                    
                    // Payment info
                    document.getElementById('view_payment_method').textContent = 'Cash'; // In a real app, this would come from the API
                    document.getElementById('view_payment_status').textContent = paymentStatus;
                    document.getElementById('view_total_amount').textContent = totalAmount;
                    
                    // Set status badge
                    const statusBadge = document.getElementById('view_order_status');
                    statusBadge.textContent = status;
                    if (status.toLowerCase() === 'pending') {
                        statusBadge.className = 'badge bg-warning';
                    } else if (status.toLowerCase() === 'preparing') {
                        statusBadge.className = 'badge bg-primary';
                    } else if (status.toLowerCase() === 'ready') {
                        statusBadge.className = 'badge bg-info';
                    } else if (status.toLowerCase() === 'completed') {
                        statusBadge.className = 'badge bg-success';
                    } else if (status.toLowerCase() === 'cancelled') {
                        statusBadge.className = 'badge bg-danger';
                    }
                    
                    // Update status timeline
                    updateStatusTimeline(status.toLowerCase());
                    
                    // Populate order items
                    const orderItemsContainer = document.getElementById('view_order_items');
                    orderItemsContainer.innerHTML = '';
                    
                    // In a real app, these would be the actual order items from the API
                    const demoItems = [
                        { name: 'Paneer Tikka', price: 250, quantity: 1 },
                        { name: 'Veg Biryani', price: 180, quantity: 2 },
                        { name: 'Garlic Naan', price: 40, quantity: 3 },
                        { name: 'Raita', price: 60, quantity: 1 }
                    ];
                    
                    let total = 0;
                    demoItems.forEach(item => {
                        const itemTotal = item.price * item.quantity;
                        total += itemTotal;
                        
                        const itemHtml = `
                            <div class="order-item d-flex justify-content-between align-items-center p-3">
                                <div>
                                    <div>${item.name}</div>
                                    <div class="small text-muted">â‚¹${item.price.toFixed(2)} x ${item.quantity}</div>
                                </div>
                                <div>â‚¹${itemTotal.toFixed(2)}</div>
                            </div>
                        `;
                        
                        orderItemsContainer.innerHTML += itemHtml;
                    });
                    
                    document.getElementById('view_items_total').textContent = `â‚¹${total.toFixed(2)}`;
                    
                    // Special instructions
                    const specialInstructionsCard = document.getElementById('view_special_instructions_card');
                    const specialInstructions = document.getElementById('view_special_instructions');
                    
                    // In a real app, this would come from the API
                    const demoInstructions = 'Please make sure the food is packed well and include extra serviettes.';
                    
                    if (demoInstructions) {
                        specialInstructions.textContent = demoInstructions;
                        specialInstructionsCard.style.display = 'block';
                    } else {
                        specialInstructionsCard.style.display = 'none';
                    }
                    
                    // Update button display based on status
                    const markAsPaidBtn = document.querySelector('.mark-as-paid');
                    if (paymentStatus.toLowerCase() === 'completed') {
                        markAsPaidBtn.style.display = 'none';
                    } else {
                        markAsPaidBtn.style.display = 'block';
                    }
                    
                    // Hide loading and show details
                    document.getElementById('order-details-loading').style.display = 'none';
                    document.getElementById('order-details').style.display = 'block';
                }, 500);
            });
        });
        
        // Update status from view modal
        document.querySelector('.update-status-from-view').addEventListener('click', function() {
            const orderId = this.getAttribute('data-id');
            document.getElementById('update_order_id').value = orderId;
            
            // Show the update status modal
            const updateStatusModal = new bootstrap.Modal(document.getElementById('updateStatusModal'));
            updateStatusModal.show();
        });
        
        // Mark as paid
        document.querySelector('.mark-as-paid').addEventListener('click', function() {
            const orderId = this.getAttribute('data-id');
            // In a real app, this would make an AJAX call to update the payment status
            alert(`Order #${orderId} has been marked as paid!`);
            this.style.display = 'none';
        });
        
        // Filter Controls
        const dateFilter = document.getElementById('dateFilter');
        const statusFilter = document.getElementById('statusFilter');
        const typeFilter = document.getElementById('typeFilter');
        const searchInput = document.getElementById('searchOrder');
        
        dateFilter.addEventListener('change', filterOrders);
        statusFilter.addEventListener('change', filterOrders);
        typeFilter.addEventListener('change', filterOrders);
        searchInput.addEventListener('input', filterOrders);
        
        function filterOrders() {
            const dateValue = dateFilter.value;
            const statusValue = statusFilter.value;
            const typeValue = typeFilter.value;
            const searchValue = searchInput.value.toLowerCase();
            
            const rows = document.querySelectorAll('tbody tr');
            
            rows.forEach(row => {
                let showRow = true;
                
                // Filter by status
                if (statusValue !== 'all') {
                    const status = row.getAttribute('data-status');
                    if (status !== statusValue) {
                        showRow = false;
                    }
                }
                
                // Filter by type
                if (typeValue !== 'all') {
                    const type = row.getAttribute('data-type');
                    if (type !== typeValue) {
                        showRow = false;
                    }
                }
                
                // Filter by search
                if (searchValue) {
                    const orderIdCell = row.querySelector('td:nth-child(1)');
                    const customerCell = row.querySelector('td:nth-child(2)');
                    
                    if (orderIdCell && customerCell) {
                        const orderIdText = orderIdCell.textContent.toLowerCase();
                        const customerText = customerCell.textContent.toLowerCase();
                        
                        if (!orderIdText.includes(searchValue) && !customerText.includes(searchValue)) {
                            showRow = false;
                        }
                    }
                }
                
                // Show/hide row
                row.style.display = showRow ? '' : 'none';
            });
        }
        
        // Order type toggle for table/address
        const orderTypeSelect = document.getElementById('order_type');
        orderTypeSelect.addEventListener('change', function() {
            const tableDiv = document.getElementById('table_number_div');
            const addressDiv = document.getElementById('address_div');
            
            if (this.value === 'dine-in') {
                tableDiv.style.display = 'block';
                addressDiv.style.display = 'none';
            } else if (this.value === 'delivery') {
                tableDiv.style.display = 'none';
                addressDiv.style.display = 'block';
            } else {
                tableDiv.style.display = 'none';
                addressDiv.style.display = 'none';
            }
        });
        
        // Add item to order
        const addItemBtn = document.getElementById('add_item_btn');
        const menuItemSelect = document.getElementById('menu_item_select');
        const itemQuantityInput = document.getElementById('item_quantity');
        const orderItemsTable = document.getElementById('order_items_table').querySelector('tbody');
        const noItemsRow = document.getElementById('no_items_row');
        const orderItemsJsonInput = document.getElementById('order_items_json');
        const orderTotalElement = document.getElementById('order_total');
        
        let orderItems = [];
        
        addItemBtn.addEventListener('click', function() {
            const selectedOption = menuItemSelect.options[menuItemSelect.selectedIndex];
            
            if (!selectedOption.value) {
                alert('Please select a menu item');
                return;
            }
            
            const itemId = selectedOption.value;
            const itemName = selectedOption.getAttribute('data-name');
            const itemPrice = parseFloat(selectedOption.getAttribute('data-price'));
            const quantity = parseInt(itemQuantityInput.value);
            
            if (quantity < 1) {
                alert('Quantity must be at least 1');
                return;
            }
            
            // Add item to the array
            orderItems.push({
                id: itemId,
                name: itemName,
                price: itemPrice,
                quantity: quantity
            });
            
            // Update the hidden input
            orderItemsJsonInput.value = JSON.stringify(orderItems);
            
            // Hide "no items" row
            noItemsRow.style.display = 'none';
            
            // Add row to table
            const newRow = document.createElement('tr');
            newRow.dataset.itemId = itemId;
            
            const itemTotal = itemPrice * quantity;
            
            newRow.innerHTML = `
                <td>${itemName}</td>
                <td>â‚¹${itemPrice.toFixed(2)}</td>
                <td>${quantity}</td>
                <td>â‚¹${itemTotal.toFixed(2)}</td>
                <td>
                    <button type="button" class="btn btn-sm btn-danger remove-item" data-id="${itemId}">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            `;
            
            orderItemsTable.appendChild(newRow);
            
            // Add event listener to remove button
            newRow.querySelector('.remove-item').addEventListener('click', function() {
                const itemId = this.getAttribute('data-id');
                removeOrderItem(itemId);
            });
            
            // Update total
            updateOrderTotal();
            
            // Reset form
            menuItemSelect.selectedIndex = 0;
            itemQuantityInput.value = 1;
        });
        
        function removeOrderItem(itemId) {
            // Remove from array
            orderItems = orderItems.filter(item => item.id !== itemId);
            
            // Update hidden input
            orderItemsJsonInput.value = JSON.stringify(orderItems);
            
            // Remove row from table
            const row = orderItemsTable.querySelector(`tr[data-item-id="${itemId}"]`);
            if (row) {
                row.remove();
            }
            
            // Show "no items" row if empty
            if (orderItems.length === 0) {
                noItemsRow.style.display = '';
            }
            
            // Update total
            updateOrderTotal();
        }
        
        function updateOrderTotal() {
            let total = 0;
            orderItems.forEach(item => {
                total += item.price * item.quantity;
            });
            
            orderTotalElement.textContent = `â‚¹${total.toFixed(2)}`;
        }
        
        // Update status timeline based on order status
        function updateStatusTimeline(status) {
            const timelineSteps = ['pending', 'preparing', 'ready', 'completed'];
            const currentIndex = timelineSteps.indexOf(status);
            
            if (currentIndex === -1) return; // Status not found in timeline
            
            timelineSteps.forEach((step, index) => {
                const marker = document.getElementById(`status-${step}`);
                
                if (index < currentIndex) {
                    // Completed steps
                    marker.classList.add('completed');
                    marker.classList.remove('active');
                } else if (index === currentIndex) {
                    // Current step
                    marker.classList.add('active');
                    marker.classList.remove('completed');
                } else {
                    // Future steps
                    marker.classList.remove('active', 'completed');
                }
            });
        }
        
        // Initialize charts
        initOrderTypeChart();
        initOrderTimeChart();
        
        function initOrderTypeChart() {
            const ctx = document.getElementById('orderTypeChart').getContext('2d');
            
            new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: ['Dine-in', 'Takeaway', 'Delivery'],
                    datasets: [{
                        data: [40, 35, 25],
                        backgroundColor: [
                            'rgba(23, 162, 184, 0.7)',
                            'rgba(0, 123, 255, 0.7)',
                            'rgba(108, 117, 125, 0.7)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }
        
        function initOrderTimeChart() {
            const ctx = document.getElementById('orderTimeChart').getContext('2d');
            
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['10-12', '12-2', '2-4', '4-6', '6-8', '8-10', '10-12'],
                    datasets: [{
                        label: 'Orders',
                        data: [10, 25, 15, 18, 30, 40, 20],
                        backgroundColor: 'rgba(255, 193, 7, 0.7)',
                        borderColor: 'rgba(255, 193, 7, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }
    });
</script>
{% endblock %}